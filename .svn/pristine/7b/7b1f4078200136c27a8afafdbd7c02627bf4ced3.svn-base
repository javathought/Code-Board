package controllers;

import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import ext.MarkdownExtensions;
import ext.TextileExtension;

import models.Issue;
import models.Project;
import models.Tracker;
import models.User;
import play.mvc.Before;

public class Application extends Main {
	
//	private static class TrackerSummary {
//		public String trackerType;
//		public long sum;
//		public long opened;
//	}

    @Before
    static void setConnectedUser() {
        if(Security.isConnected()){
            User user = User.find("byLogin",Security.connected()).first();
            renderArgs.put("username", user);
            // TODO : examine the path of k33g.org
//            renderArgs.put("security",Security.connected());
//        } else {
//            renderArgs.put("username", new User("","","John Doe"));
        }
    }
	
    public static void index() {
        List<Project> projects = Project.all().fetch();
        render(projects);	

//        render();
    }

	public static void project (String identifier) {
		Project project = Project.find("identifier", identifier).first();
		List<Tracker> trackers = Tracker.findAll();
		Tracker tracker;
		Map summary = new HashMap();
		Map opened = new HashMap();
		
		Iterator trackerCursor = trackers.iterator();		
		while (trackerCursor.hasNext()) {
			tracker = (Tracker) trackerCursor.next();
			long i = Issue.count("tracker = ? and project = ?", tracker, project);
			long j = Issue.count("tracker = ? and project = ? and state.closed = ? ", tracker, project, false);
			summary.put(tracker.id, i);
			opened.put(tracker.id, j);
		}
		
		render(project, trackers, summary, opened);

	}
	
    public static void textile(String data) {
    	renderText(TextileExtension.textile(data));
    	
    }

    public static void markdown(String data) {
    	renderText(MarkdownExtensions.markdown(data));
    	
    }

    
}